<!doctype html>
<html>
	<head>
		<script type="text/javascript" src="../vendors/jquery-1.3.2.js"></script>
		<script type="text/javascript" src="../vendors/sha1.js"></script>
		<script type="text/javascript" src="../vendors/oauth.js"></script>
		<script type="text/javascript" src="../vendors/lawnchair-0.3.1/adaptors/LawnchairAdaptorHelpers.js"></script>
		<script type="text/javascript" src="../vendors/lawnchair-0.3.1/adaptors/WebkitSQLiteAdaptor.js"></script>
		<script type="text/javascript" src="../vendors/lawnchair-0.3.1/Lawnchair.js"></script>
		<script type="text/javascript" src="../builds/spazcore-standard.js"></script>
		<script type="text/javascript" src="../incubator/libs/spazdb.js"></script>
		<script type="text/javascript" src="../incubator/libs/spazoauth.js"></script>
		<style type="text/css">
			#requestWindow, #authWindow, #successWindow, #homeTimeline {
				border: solid 1px gray;
				text-align: center;
				width: 50%;
				padding: 5em;
			}
		</style>
	</head>
	<body>
		<script type="text/javascript">

			var consumer = new SpazOAuth({
				'service' : 'twitter'
			});


			function getTokens() {
				if (consumer.getRequestToken()) {
					$('#requestWindow').fadeOut('fast');
					$('#authWindow').fadeIn('slow');
				} else {
					alert('Failed getting request token.');
				}
			}


			function authorizeUser() {
				var accessPIN = $('#twitterPin').val();

				if (consumer.requestToken && accessPIN) {
					if (consumer.getAuthorization(accessPIN)) {
						$('#accessToken').text(consumer.accessToken);
						$('#authWindow').fadeOut('fast');
						$('#successWindow').fadeIn('slow');
					} else {
						alert('Failed getting access token.');
					}
				} else {
					alert('You must enter an access PIN.');
				}
			}


			function getTimeline() {
				if (consumer.accessToken) {
					var authHeader = consumer.getAuthHeader({
						method: 'get',
						url: 'https://twitter.com/statuses/home_timeline.json'
					});

					$.ajax({
						type: 'get',
						url: 'https://twitter.com/statuses/home_timeline.json',
						dataType: 'json',
						beforeSend: function(req) {
							req.setRequestHeader('Authorization', authHeader);
						},
						success: function(data, textStatus) {
							updateTimeline(data);
						}
					});

				} else {
					alert('You need an access token first.');
				}
			}


			function updateTimeline(timelineData) {
				if (!timelineData) {
					timelineData = [];
				}

				var timeline = '<ul>';
				for (var i in timelineData) {
					timeline += '<li>';
					timeline += '<strong>' + timelineData[i].user.screen_name + '</strong>: ';
					timeline += timelineData[i].text;
					timeline += '</li>';
				}
				timeline += '</ul>';

				$('#timeline').html(timeline);
			}
		</script>
		<div id="requestWindow" style="display: block;">
			<button onclick="getTokens();">Click me to authorize Twitter access!</button>
		</div>
		<div id="authWindow" style="display: none;">
			<label for="twitterPin">Enter Twitter PIN:</label>
			<input id="twitterPin" type="text" value="" />
			<button onclick="authorizeUser();">Authorize!</button>
		</div>
		<div id="successWindow" style="display: none;">
			<h1>Congratulations!</h1>
			<p>You're now authorized with Twitter!</p>
			<p>Your <code>access_token</code> is: <span id="accessToken"></span>.</p>
		</div>
		<div id="homeTimeline">
			<button onclick="getTimeline();">Get your timeline!</button>
			<div id="timeline" style="text-align: left;"></div>
		</div>
	</body>
</html>
